Threads =
{
    -- item id, item name, thread count 
    experience = {
        { currency_id = 3001, stat_name = "% experience", thread_id = 217722, thread_name = "Thread of Experience", thread_count = 1 },
        { currency_id = 3001, stat_name = "% experience", thread_id = 219264, thread_name = "Temporal Thread of Experience", thread_count = 3 },
        { currency_id = 3001, stat_name = "% experience", thread_id = 219273, thread_name = "Perpetual Thread of Experience", thread_count = 7 },
        { currency_id = 3001, stat_name = "% experience", thread_id = 219282, thread_name = "Infinite Thread of Experience", thread_count = 12 }
    },

    power = {
        { currency_id = 2853, stat_name = "main stat", thread_id = 210982, thread_name = "Thread of Power", thread_count = 1 },
        { currency_id = 2853, stat_name = "main stat", thread_id = 219256, thread_name = "Temporal Thread of Power", thread_count = 3 },
        { currency_id = 2853, stat_name = "main stat", thread_id = 219265, thread_name = "Perpetual Thread of Power", thread_count = 7 },
        { currency_id = 2853, stat_name = "main stat", thread_id = 219274, thread_name = "Infinite Thread of Power", thread_count = 12 }
    },

    critical_strike = {
        { currency_id = 2855, stat_name = "crit chance", thread_id = 210984, thread_name = "Thread of Critical Strike", thread_count = 1 },
        { currency_id = 2855, stat_name = "crit chance", thread_id = 219258, thread_name = "Temporal Thread of Critical Strike", thread_count = 3 },
        { currency_id = 2855, stat_name = "crit chance", thread_id = 219267, thread_name = "Perpetual Thread of Critical Strike", thread_count = 7 },
        { currency_id = 2855, stat_name = "crit chance", thread_id = 219276, thread_name = "Infinite Thread of Critical Strike", thread_count = 12 }
    },

    haste = {
        { currency_id = 2856, stat_name = "haste", thread_id = 210985, thread_name = "Thread of Haste", thread_count = 1 },
        { currency_id = 2856, stat_name = "haste", thread_id = 219259, thread_name = "Temporal Thread of Haste", thread_count = 3 },
        { currency_id = 2856, stat_name = "haste", thread_id = 219268, thread_name = "Perpetual Thread of Haste", thread_count = 7 },
        { currency_id = 2856, stat_name = "haste", thread_id = 219277, thread_name = "Infinite Thread of Haste", thread_count = 12 }
    },

    leech = {
        { currency_id = 2857, stat_name = "leech", thread_id = 210987, thread_name = "Thread of Leech", thread_count = 1 },
        { currency_id = 2857, stat_name = "leech", thread_id = 219261, thread_name = "Temporal Thread of Leech", thread_count = 3 },
        { currency_id = 2857, stat_name = "leech", thread_id = 219270, thread_name = "Perpetual Thread of Leech", thread_count = 7 },
        { currency_id = 2857, stat_name = "leech", thread_id = 219279, thread_name = "Infinite Thread of Leech", thread_count = 12 }        
    },

    mastery = {
        { currency_id = 2858, stat_name = "mastery", thread_id = 210989, thread_name = "Thread of Mastery", thread_count = 1 },
        { currency_id = 2858, stat_name = "mastery", thread_id = 219262, thread_name = "Temporal Thread of Mastery", thread_count = 3 },
        { currency_id = 2858, stat_name = "mastery", thread_id = 219271, thread_name = "Perpetual Thread of Mastery", thread_count = 7 },
        { currency_id = 2858, stat_name = "mastery", thread_id = 219280, thread_name = "Infinite Thread of Mastery", thread_count = 12 }     
    },

    speed = {
        { currency_id = 2859, stat_name = "speed", thread_id = 210986, thread_name = "Thread of Speed", thread_count = 1 },
        { currency_id = 2859, stat_name = "speed", thread_id = 219260, thread_name = "Temporal Thread of Speed", thread_count = 3 },
        { currency_id = 2859, stat_name = "speed", thread_id = 219269, thread_name = "Perpetual Thread of Speed", thread_count = 7 },
        { currency_id = 2859, stat_name = "speed", thread_id = 219278, thread_name = "Infinite Thread of Speed", thread_count = 12 }        
    },

    stamina = {
        { currency_id = 2854, stat_name = "stamina", thread_id = 210983, thread_name = "Thread of Stamina", thread_count = 2 },
        { currency_id = 2854, stat_name = "stamina", thread_id = 219257, thread_name = "Temporal Thread of Stamina", thread_count = 6 },
        { currency_id = 2854, stat_name = "stamina", thread_id = 219266, thread_name = "Perpetual Thread of Stamina", thread_count = 14 },
        { currency_id = 2854, stat_name = "stamina", thread_id = 219275, thread_name = "Infinite Thread of Stamina", thread_count = 24 }        
    },

    versatility = {
        { currency_id = 2860, stat_name = "versatility", thread_id = 210990, thread_name = "Thread of Versatility", thread_count = 1 },
        { currency_id = 2860, stat_name = "versatility", thread_id = 219263, thread_name = "Temporal Thread of Versatility", thread_count = 3 },
        { currency_id = 2860, stat_name = "versatility", thread_id = 219272, thread_name = "Perpetual Thread of Versatility", thread_count = 7 },
        { currency_id = 2860, stat_name = "versatility", thread_id = 219281, thread_name = "Infinite Thread of Versatility", thread_count = 12 }
    },
}

Currency = {
    bronze = {
        { currency_id = 2778, currency_name = "Bronze", currency_item_id = 217174 }
    },

    lesser_charm_of_good_fortune = {
        { currency_id = 738, currency_name = "Lesser Charm of Good Fortune", currency_item_id = 90458, item_link = "|cFFFFFFFF|Hcurrency:738|h[Lesser Charm of Good Fortune]|h|r" }
    },
}

Items = {
    gems = {
        { currency_id = 0, stat_name = "Chipped Masterful Amethyst", thread_id = 210715, thread_name = "Chipped Masterful Amethyst", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Deadly Sapphire", thread_id = 210714, thread_name = "Chipped Deadly Sapphire", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Quick Topaz", thread_id = 210681, thread_name = "Chipped Quick Topaz", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Versatile Diamond", thread_id = 220371, thread_name = "Chipped Versatile Diamond", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Stalwart Pearl", thread_id = 220367, thread_name = "Chipped Stalwart Pearl", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Sustaining Emerald", thread_id = 211109, thread_name = "Chipped Sustaining Emerald", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Hungering Ruby", thread_id = 210717, thread_name = "Chipped Hungering Ruby", thread_count = -1, is_gem = true },
        { currency_id = 0, stat_name = "Chipped Swift Opal", thread_id = 210716, thread_name = "Chipped Swift Opal", thread_count = -1, is_gem = true },
    }
}

local function ProcessCurrencyUpdate_Thread(currencyType, quantityChange, quantityGainSource)
    for i, thread in pairs(Threads) do 
        for index, thread_table in pairs(thread) do
            if thread_table.currency_id == currencyType and thread_table.thread_count == quantityChange then
                local item = Item:CreateFromItemID(thread_table.thread_id)
                item:ContinueOnItemLoad(function()
                    ThreadWatcher.session.loot.AddThread(thread_table.thread_id, item:GetItemLink(), thread_table)
                end)
                return true
            elseif quantityChange > thread_table.thread_count and thread_table.currency_id == currencyType and index >= 4 then
                if quantityChange == 100 and currencyType == 3001 then
                    return true
                end
                
                ThreadWatcher:Print(string.format("quantity change = %i | currency type = %i | quantityGainSource = %i | index = %i", quantityChange, currencyType, quantityGainSource, index))
                local remaining = quantityChange
                local result = {}

                table.sort(thread, function(a, b) return a.thread_count > b.thread_count end)

                for _, t in ipairs(thread) do
                    if t.thread_count <= remaining and t.thread_count > 0 then
                        local count = math.floor(remaining / t.thread_count)
                        remaining = remaining - (count * t.thread_count)
                        result[t.thread_id] = { count = count, thread_table = t }
                    end
                end

                for thread_id, remain_table in pairs(result) do
                    
                    local item = Item:CreateFromItemID(thread_id)
                    item:ContinueOnItemLoad(function()
                        for _ = 1, remain_table.count do
                            ThreadWatcher.session.loot.AddThread(thread_id, item:GetItemLink(), remain_table.thread_table)
                        end
                    end)
                end
                return true
            end
        end
    end
    return false
end

local function ProcessCurrencyUpdate_Currency(currencyType, quantityChange)
    for i, table in pairs(Currency) do
        for _, currency_table in pairs(table) do
            if currencyType == currency_table.currency_id then
                if currency_table.thread_name == "Bronze" and ThreadWatcher.db.profile.bronze.track_bronze == false then
                    return
                elseif currency_table.thread_name == "Lesser Charm of Good Fortune" and ThreadWatcher.db.profile.lesser_charms.track_charms == false then
                    return
                end

                
                if currency_table.item_link ~= nil then
                    ThreadWatcher.session.loot.AddCurrency(currency_table.currency_id, currency_table.item_link, quantityChange, currency_table.currency_name)
                else
                    local item = Item:CreateFromItemID(currency_table.currency_item_id)
                    item:ContinueOnItemLoad(function()
                        ThreadWatcher.session.loot.AddCurrency(currency_table.currency_id, item:GetItemLink(), quantityChange, currency_table.currency_name)
                    end)
                end
                
            end
        end
    end
end

local function ProcessPlayerLoot_Gem(item_id, amount)
    for i, table in pairs(Items) do
        for index, item_table in pairs(table) do
            if item_table.thread_id == item_id then
                ThreadWatcher.session.loot.AddGem(1, "|cFF1EFF00[Tier 1 Gem]|r", amount)
            end
        end
    end
end

local function ProcessPlayerLoot_Gear(item_quality, amount)
    if item_quality == Enum.ItemQuality.Uncommon then
        ThreadWatcher.session.loot.AddItem(2, "|cFF1EFF00[Uncommon Gear]|r", amount)
    elseif item_quality == Enum.ItemQuality.Rare then
        ThreadWatcher.session.loot.AddItem(3, "|cFF0070DD[Rare Gear]|r", amount)
    elseif item_quality == Enum.ItemQuality.Epic then
        ThreadWatcher.session.loot.AddItem(4, "|cFFA335EE[Epic Gear]|r", amount)
    end
end

PlayerGUID = UnitGUID("player")
function eventHandler(self, event, ...)
    PlayerGUID = UnitGUID("player")
    local timer_active = ThreadWatcher.session.IsTimerActive()
    if event == "CURRENCY_DISPLAY_UPDATE" and timer_active == true then 
        local currencyType, quantity, quantityChange, quantityGainSource, quantityLostSource = ...;

        if currencyType == nil or quantityChange == nil or quantityChange < 0 then
            return
        end

        local thread_handled = ProcessCurrencyUpdate_Thread(currencyType, quantityChange, quantityGainSource)
        if thread_handled == false then
            ProcessCurrencyUpdate_Currency(currencyType, quantityChange)
        end
        
    elseif event == "CHAT_MSG_LOOT" and timer_active == true then
        
        local text, playerName, languageName, channelName, playerName2, specialFlags, zoneChannelID, channelIndex, channelBaseName, languageID, lineID, guid, bnSenderID, isMobile, isSubtitle, hideSenderInLetterbox, supressRaidIcons = ...;
        if guid ~= PlayerGUID then
            return
        end
        local number_r = string.match(text, "Hitem:(%d+)") 
        local quantity_r = string.match(text, "|rx(%d+)")
        local item_id = number_r and tonumber(number_r) or 0
        local quantity = (quantity_r and tonumber(quantity_r)) or 1

        local itemName, itemLink, itemQuality, itemLevel, itemMinLevel, itemType, itemSubType, itemStackCount, itemEquipLoc, itemTexture, sellPrice, classID, subclassID, bindType, expansionID, setID, isCraftingReagent = C_Item.GetItemInfo(item_id)
        if itemType == "Gem" and ThreadWatcher.db.profile.gems.track_gems == true then
            ProcessPlayerLoot_Gem(item_id, quantity)
        elseif (itemType == "Armor" or itemType == "Weapon") and ThreadWatcher.db.profile.gear.track_gear == true then
            local item = Item:CreateFromItemID(item_id)
            item:ContinueOnItemLoad(function()
                -- This is bugged as hell, GetItemQuality doesn't actually give the proper quality, it gives rare only.
                -- Might be because they're remix items? No clue. Neck worked before.
                ProcessPlayerLoot_Gear(item:GetItemQuality(), quantity)
            end)
        end
    end
end

local event_frame = CreateFrame("EventFrame", "ThreadWatcher")
event_frame:RegisterEvent("CURRENCY_DISPLAY_UPDATE")
event_frame:RegisterEvent("CHAT_MSG_LOOT")
event_frame:SetScript("OnEvent", eventHandler)
event_frame:Hide()